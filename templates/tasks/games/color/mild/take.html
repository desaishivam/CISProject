{% extends 'layouts/base.html' %}
{% block title %}Mild Color Matching Game - CogniCare{% endblock %}
{% csrf_token %}

{% block content %}
<div class="container">
    <div class="task-header">
        <h1>Mild Color Matching Game</h1>
        <p>Match the color pairs.</p>
    </div>

    <div class="stats-container">
        <div>Score: <span id="score">0</span></div>
        <div>Pairs: <span id="pairs">0</span>/8</div>
        <div>Time: <span id="time">00:00</span></div>
    </div>

    <div id="previewBadge" class="preview-badge" style="display:none;">
        Memorize the layout! <span id="previewCountdown">2</span>
    </div>

    <div class="game-container">
        <div class="game-board" id="gameBoard"></div>
    </div>
    <div id="feedback" class="feedback" style="display: none;"></div>
</div>

<style>
    body {
        font-family: Arial, sans-serif;
        background: #f2f6f9;
        margin: 0;
        padding: 0;
    }
    .container {
        max-width: 900px;
        margin: auto;
        padding: 2rem;
    }
    .task-header {
        text-align: center;
        margin-bottom: 1.5rem;
    }
    .task-header h1 {
        color: #2c3e50;
        font-size: 2.5em;
        margin-bottom: 0.5rem;
    }
    .task-header p {
        color: #7f8c8d;
        font-size: 1.2em;
    }
    .stats-container {
        display: flex;
        justify-content: space-around;
        background: #e9ecef;
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 1.5rem;
    }
    .preview-badge {
        display: inline-block;
        background: #fffbe6;
        color: #b8860b;
        border: 1px solid #ffe58f;
        border-radius: 8px;
        padding: 0.5em 1em;
        font-size: 1.1em;
        margin: 0 auto 1em auto;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.07);
    }
    .game-container {
        display: flex;
        justify-content: center;
    }
    .game-board {
        display: grid;
        gap: 12px;
        width: 100%;
        grid-template-columns: repeat(4, 1fr);
        max-width: 440px;
    }
    .color-card {
        background: #ddd;
        border-radius: 15px;
        border: 3px solid #e0e0e0;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1em;
        font-weight: bold;
        color: white;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        position: relative;
        user-select: none;
        aspect-ratio: 1;
    }
    .color-card.matched {
        opacity: 0.6;
        cursor: not-allowed;
        transform: scale(0.95);
        background: #28a745 !important;
    }
    .color-card.selected {
        border-color: #667eea !important;
        border-width: 4px !important;
        box-shadow: 0 0 20px rgba(102,126,234,0.4);
        transform: scale(1.08);
    }
    .color-card.hidden {
        background: #f0f0f0 !important;
        color: transparent !important;
        border-color: #ccc;
    }
    .color-card.hidden::after {
        content: '?';
        position: absolute;
        font-size: 2.2em;
        color: #888;
        left: 50%;
        top: 50%;
        transform: translate(-50%,-50%);
        pointer-events: none;
    }
    .feedback {
        text-align: center;
        font-size: 1.1em;
        font-weight: bold;
        margin: 15px 0 0 0;
        padding: 12px 16px;
        border-radius: 10px;
        transition: all 0.3s;
        display: none;
    }
    .feedback.success {
        background: linear-gradient(90deg, #27ae60, #2ecc71);
        color: white;
        box-shadow: 0 4px 12px rgba(39,174,96,0.3);
    }
    .feedback.error {
        background: linear-gradient(90deg, #e74c3c, #c0392b);
        color: white;
        box-shadow: 0 4px 12px rgba(231,76,60,0.3);
    }
    @media (max-width: 700px) {
        .game-board { grid-template-columns: repeat(3, 1fr); }
    }
</style>

<script>
const colorPairs = [
    { name: 'Red', color: '#e74c3c' },
    { name: 'Blue', color: '#3498db' },
    { name: 'Green', color: '#27ae60' },
    { name: 'Yellow', color: '#f1c40f' },
    { name: 'Purple', color: '#9b59b6' },
    { name: 'Orange', color: '#f39c12' },
    { name: 'Brown', color: '#8b4513' },
    { name: 'Gray', color: '#6c757d' }
];

let state;
let previewTimer;
let previewCountdown = 2;

function initializeGame() {
    let cards = [];
    colorPairs.forEach(pair => {
        cards.push({ ...pair, matched: false });
        cards.push({ ...pair, matched: false });
    });
    cards = cards.sort(() => Math.random() - 0.5);
    state = { cards, flipped: [], matched: 0, score: 0, startTime: null, timer: null, preview: true };
    renderGame(true);
    updateStats();
    document.getElementById('previewBadge').style.display = 'block';
    previewCountdown = 2;
    document.getElementById('previewCountdown').textContent = previewCountdown;
    clearInterval(state.timer);
    clearInterval(previewTimer);
    previewTimer = setInterval(() => {
        previewCountdown--;
        document.getElementById('previewCountdown').textContent = previewCountdown;
        if (previewCountdown === 0) {
            clearInterval(previewTimer);
            document.getElementById('previewBadge').style.display = 'none';
            state.preview = false;
            state.startTime = Date.now();
            renderGame();
            state.timer = setInterval(updateTimer, 1000);
        }
    }, 1000);
}

function renderGame(preview = false) {
    const board = document.getElementById('gameBoard');
    board.innerHTML = '';
    state.cards.forEach((card, index) => {
        const el = document.createElement('div');
        el.className = 'color-card';
        el.style.backgroundColor = card.color;
        if (card.matched || state.flipped.includes(index) || preview || state.preview) {
            el.textContent = card.name;
            if (card.matched) el.classList.add('matched');
        } else {
            el.classList.add('hidden');
            el.onclick = () => flipCard(index);
        }
        board.appendChild(el);
    });
}

function flipCard(index) {
    if (state.flipped.length >= 2 || state.flipped.includes(index) || state.cards[index].matched) return;
    state.flipped.push(index);
    renderGame();
    if (state.flipped.length === 2) {
        const [i1, i2] = state.flipped;
        if (state.cards[i1].name === state.cards[i2].name) {
            state.cards[i1].matched = state.cards[i2].matched = true;
            state.matched++;
            state.score += 20;
            state.flipped = [];
            renderGame();
            if (state.matched === state.cards.length / 2) gameCompleted();
        } else {
            setTimeout(() => {
                state.flipped = [];
                renderGame();
            }, 800);
        }
    }
    updateStats();
}

function updateStats() {
    document.getElementById('score').textContent = state.score;
    document.getElementById('pairs').textContent = state.matched;
}

function updateTimer() {
    const elapsed = Math.floor((Date.now() - state.startTime) / 1000);
    const min = String(Math.floor(elapsed / 60)).padStart(2, '0');
    const sec = String(elapsed % 60).padStart(2, '0');
    document.getElementById('time').textContent = `${min}:${sec}`;
}

function showFeedback(message, type) {
    const feedback = document.getElementById('feedback');
    feedback.textContent = message;
    feedback.className = `feedback ${type}`;
    feedback.style.display = 'block';
    setTimeout(() => { feedback.style.display = 'none'; }, 1500);
}

function gameCompleted() {
    clearInterval(state.timer);
    const totalTime = Math.floor((Date.now() - state.startTime) / 1000);
    showFeedback(`Completed! Time: ${totalTime}s`, 'success');
    setTimeout(() => {
        submitResults({
            score: state.score,
            totalTime: totalTime,
            pairs: state.matched,
            difficulty: 'mild'
        });
    }, 1500);
}

function submitResults(results) {
    fetch(window.location.href, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(results)
    }).then(() => {
        window.location.href = '/tasks/patient/tasks/';
    }).catch(() => {
        window.location.href = '/tasks/patient/tasks/';
    });
}

initializeGame();
</script>
{% endblock %} 