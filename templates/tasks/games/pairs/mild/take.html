{% extends 'layouts/base.html' %}
{% block title %}Mild Matching Game - CogniCare{% endblock %}

{% block content %}
<div class="container">
    <div class="task-header">
        <h1>ðŸ§  Mild Matching Game</h1>
        <p>Match pairs of identical emojis â€” cards flip back if not matched.</p>
    </div>

    <div class="stats-container">
        <div>Moves: <span id="moves">0</span></div>
        <div>Matches: <span id="matches">0</span></div>
        <div>Time: <span id="time">00:00</span></div>
    </div>

    <div id="previewBadge" class="preview-badge" style="display:none;">
        Memorize the layout! <span id="previewCountdown">3</span>
    </div>

    <div class="game-container">
        <div class="game-board" id="gameBoard"></div>
    </div>

    <div class="victory-modal" id="victory">
        <div class="victory-content">
            <h2>ðŸŽ‰ You did it!</h2>
            <p>Moves: <span id="finalMoves"></span></p>
            <p>Time: <span id="finalTime"></span></p>
            <button onclick="initializeGame()">Play Again</button>
        </div>
    </div>
</div>

<style>
    body {
        font-family: Arial, sans-serif;
        background: #f2f6f9;
        margin: 0;
        padding: 0;
    }

    .container {
        max-width: 900px;
        margin: auto;
        padding: 2rem;
    }

    .task-header {
        text-align: center;
        margin-bottom: 1.5rem;
    }

    .task-header h1 {
        color: #2c3e50;
        font-size: 2.5em;
        margin-bottom: 0.5rem;
    }

    .task-header p {
        color: #7f8c8d;
        font-size: 1.2em;
    }

    .stats-container {
        display: flex;
        justify-content: space-around;
        background: #e9ecef;
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 1.5rem;
    }

    .preview-badge {
        display: inline-block;
        background: #fffbe6;
        color: #b8860b;
        border: 1px solid #ffe58f;
        border-radius: 8px;
        padding: 0.5em 1em;
        font-size: 1.1em;
        margin: 0 auto 1em auto;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.07);
    }

    .game-container {
        display: flex;
        justify-content: center;
    }

    .game-board {
        display: grid;
        gap: 12px;
        width: 100%;
        grid-template-columns: repeat(6, 1fr);
    }

    .card {
        background: white;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        padding: 1rem;
        text-align: center;
        user-select: none;
        font-size: 2em;
        transition: background 0.3s;
    }

    .card.matched {
        background: #28a745;
        color: white;
        cursor: default;
    }

    .card-back {
        background: #dee2e6;
        color: #6c757d;
        border-radius: 10px;
        padding: 1rem;
        width: 100%;
        text-align: center;
    }

    .victory-modal {
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 999;
    }

    .victory-content {
        background: white;
        padding: 2rem;
        border-radius: 10px;
        text-align: center;
        max-width: 300px;
        margin: 10% auto;
    }

    @media (max-width: 700px) {
        .game-board { grid-template-columns: repeat(4, 1fr); }
    }
</style>

<script>
    const emojiPairs = [
        'ðŸ¶', 'ðŸ±', 'ðŸŽ', 'ðŸŒ', 'ðŸŒž', 'ðŸŒ™', 'ðŸ”¥', 'ðŸ’§',
        'âš¡', 'â˜ï¸', 'ðŸ ', 'ðŸ¢', 'ðŸ“š', 'âœï¸', 'ðŸŽµ', 'ðŸŽ¤',
        'ðŸš—', 'ðŸšŒ', 'ðŸ•', 'ðŸ”', 'ðŸ¦‹', 'ðŸ¸', 'ðŸŒ¸', 'ðŸŒ²'
    ];

    let state;
    let previewTimer;
    let previewCountdown = 3;

    function initializeGame() {
        const pairCount = 12;
        let selected = emojiPairs.slice(0, pairCount);
        let cards = [];
        selected.forEach(emoji => {
            cards.push({ emoji: emoji, matched: false });
            cards.push({ emoji: emoji, matched: false });
        });
        cards = cards.sort(() => Math.random() - 0.5);
        state = { cards, flipped: [], matched: 0, moves: 0, startTime: null, timer: null, preview: true };
        renderGame(true); // Show all cards face up for preview
        updateStats();
        document.getElementById('previewBadge').style.display = 'block';
        previewCountdown = 3;
        document.getElementById('previewCountdown').textContent = previewCountdown;
        clearInterval(state.timer);
        clearInterval(previewTimer);
        previewTimer = setInterval(() => {
            previewCountdown--;
            document.getElementById('previewCountdown').textContent = previewCountdown;
            if (previewCountdown === 0) {
                clearInterval(previewTimer);
                document.getElementById('previewBadge').style.display = 'none';
                state.preview = false;
                state.startTime = Date.now();
                renderGame();
                state.timer = setInterval(updateTimer, 1000);
            }
        }, 1000);
    }

    function renderGame(preview = false) {
        const board = document.getElementById('gameBoard');
        board.innerHTML = '';
        state.cards.forEach((card, index) => {
            const el = document.createElement('div');
            el.className = 'card';
            if (card.matched || state.flipped.includes(index) || preview || state.preview) {
                el.innerHTML = `<div>${card.emoji}</div>`;
                if (card.matched) el.classList.add('matched');
            } else {
                el.innerHTML = '<div class="card-back">?</div>';
                el.onclick = () => flipCard(index);
            }
            board.appendChild(el);
        });
    }

    function flipCard(index) {
        if (state.flipped.length >= 2 || state.flipped.includes(index) || state.cards[index].matched) return;
        state.flipped.push(index);
        renderGame();
        if (state.flipped.length === 2) {
            state.moves++;
            const [i1, i2] = state.flipped;
            if (state.cards[i1].emoji === state.cards[i2].emoji) {
                state.cards[i1].matched = state.cards[i2].matched = true;
                state.matched++;
                state.flipped = [];
                if (state.matched === state.cards.length / 2) endGame();
                renderGame();
            } else {
                setTimeout(() => {
                    state.flipped = [];
                    renderGame();
                }, 900);
            }
        }
        updateStats();
    }

    function updateStats() {
        document.getElementById('moves').textContent = state.moves;
        document.getElementById('matches').textContent = state.matched;
    }

    function updateTimer() {
        const elapsed = Math.floor((Date.now() - state.startTime) / 1000);
        const min = String(Math.floor(elapsed / 60)).padStart(2, '0');
        const sec = String(elapsed % 60).padStart(2, '0');
        document.getElementById('time').textContent = `${min}:${sec}`;
    }

    function endGame() {
        clearInterval(state.timer);
        document.getElementById('finalMoves').textContent = state.moves;
        document.getElementById('finalTime').textContent = document.getElementById('time').textContent;
        document.getElementById('victory').style.display = 'block';
    }

    initializeGame();
</script>
{% endblock %}
