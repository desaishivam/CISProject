{% extends 'layouts/base.html' %}
{% block title %}Matching Game{% endblock %}
{% csrf_token %}

{% block content %}
<div class="container">
    <div class="task-header">
        <h1>Pairing Game</h1>
        <p>Pair together the related items.</p>
    </div>

    <div class="stats-container">
        <div>Moves: <span id="moves">0</span></div>
        <div>Matches: <span id="matches">0</span></div>
        <div>Time: <span id="time">00:00</span></div>
    </div>

    <div class="game-container">
        <div class="game-board" id="gameBoard"></div>
    </div>
</div>

<style>
    body {
        font-family: Arial, sans-serif;
        background: #f2f6f9;
        margin: 0;
        padding: 0;
    }

    .container {
        max-width: 900px;
        margin: auto;
        padding: 2rem;
    }

    .task-header {
        text-align: center;
        margin-bottom: 1.5rem;
    }

    .task-header h1 {
        color: #2c3e50;
        font-size: 2.5em;
        margin-bottom: 0.5rem;
    }

    .task-header p {
        color: #7f8c8d;
        font-size: 1.2em;
    }

    .stats-container {
        display: flex;
        justify-content: space-around;
        background: #e9ecef;
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 1.5rem;
    }

    .preview-badge {
        display: inline-block;
        background: #fffbe6;
        color: #b8860b;
        border: 1px solid #ffe58f;
        border-radius: 8px;
        padding: 0.5em 1em;
        font-size: 1.1em;
        margin: 0 auto 1em auto;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0,0,0,0.07);
    }

    .game-container {
        display: flex;
        justify-content: center;
    }

    .game-board {
        display: grid;
        gap: 12px;
        width: 100%;
        grid-template-columns: repeat(6, 1fr);
    }

    .card {
        background: white;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        padding: 1rem;
        text-align: center;
        user-select: none;
        font-size: 2em;
        transition: background 0.3s;
    }

    .card.matched {
        background: #28a745;
        color: white;
        cursor: default;
    }

    .card-back {
        background: #dee2e6;
        color: #6c757d;
        border-radius: 10px;
        padding: 1rem;
        width: 100%;
        text-align: center;
    }

    .victory-modal {
        display: none;
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 999;
    }

    .victory-content {
        background: white;
        padding: 2rem;
        border-radius: 10px;
        text-align: center;
        max-width: 300px;
        margin: 10% auto;
    }

    .card.wrong {
        border: 2px solid #e74c3c;
        background: #fdecea;
    }

    .card.selected {
        border: 2px solid #3498db;
        background: #eaf6fb;
    }

    @media (max-width: 700px) {
        .game-board { grid-template-columns: repeat(4, 1fr); }
    }
</style>

<script>
    const emojiPairs = [
        { id: 1, emoji: '🐶' }, { id: 1, emoji: '🐱' },
        { id: 2, emoji: '🍎' }, { id: 2, emoji: '🍌' },
        { id: 3, emoji: '🌞' }, { id: 3, emoji: '🌙' },
        { id: 4, emoji: '🔥' }, { id: 4, emoji: '💧' },
        { id: 5, emoji: '⚡' }, { id: 5, emoji: '☁️' },
        { id: 6, emoji: '🏠' }, { id: 6, emoji: '🏢' },
        { id: 7, emoji: '📚' }, { id: 7, emoji: '✏️' },
        { id: 8, emoji: '🎵' }, { id: 8, emoji: '🎤' },
        { id: 9, emoji: '🚗' }, { id: 9, emoji: '🚌' },
        { id: 10, emoji: '🍕' }, { id: 10, emoji: '🍔' },
        { id: 11, emoji: '🦋' }, { id: 11, emoji: '🐸' },
        { id: 12, emoji: '🌸' }, { id: 12, emoji: '🌲' }
    ];

    let state;

    function initializeGame() {
        const pairCount = 12;
        let selected = emojiPairs.slice(0, pairCount * 2);
        let cards = [];
        selected.forEach(pair => {
            cards.push({ id: pair.id, emoji: pair.emoji, matched: false });
            });
        cards = cards.sort(() => Math.random() - 0.5);
        state = { cards, flipped: [], matched: 0, moves: 0, startTime: null, timer: null, wrong: [], completed: false };
        renderGame();
        updateStats();
        clearInterval(state.timer);
        state.startTime = Date.now();
        state.timer = setInterval(updateTimer, 1000);
    }

    function renderGame() {
        const board = document.getElementById('gameBoard');
        board.innerHTML = '';
        state.cards.forEach((card, index) => {
            const el = document.createElement('div');
            el.className = 'card';
            el.innerHTML = `<div>${card.emoji}</div>`;
            if (card.matched) {
                el.classList.add('matched');
            } else if (state.wrong && state.wrong.includes(index)) {
                el.classList.add('wrong');
            } else if (state.flipped.includes(index)) {
                el.classList.add('selected');
            } else {
                el.onclick = () => flipCard(index);
            }
            board.appendChild(el);
        });
        if (!state.completed && state.matched === state.cards.length / 2) {
            state.completed = true;
            gameCompleted();
        }
    }

    function flipCard(index) {
        if (state.flipped.length >= 2 || state.cards[index].matched || state.flipped.includes(index)) return;
        state.flipped.push(index);
        renderGame();
        if (state.flipped.length === 2) {
            state.moves++;
            const [i1, i2] = state.flipped;
            if (state.cards[i1].id === state.cards[i2].id) {
                state.cards[i1].matched = state.cards[i2].matched = true;
                state.matched++;
                state.flipped = [];
                renderGame();
                if (state.matched === state.cards.length / 2) gameCompleted();
        } else {
                state.wrong = [i1, i2];
                renderGame();
                setTimeout(() => {
                    state.flipped = [];
                    state.wrong = [];
                    renderGame();
                }, 1000);
            }
        }
        updateStats();
    }

    function updateStats() {
        document.getElementById('moves').textContent = state.moves;
        document.getElementById('matches').textContent = state.matched;
    }

    function updateTimer() {
        const elapsed = Math.floor((Date.now() - state.startTime) / 1000);
        const min = String(Math.floor(elapsed / 60)).padStart(2, '0');
        const sec = String(elapsed % 60).padStart(2, '0');
        document.getElementById('time').textContent = `${min}:${sec}`;
    }

    function gameCompleted() {
        clearInterval(state.timer);
        const totalTime = Math.floor((Date.now() - state.startTime) / 1000);
        const results = {
            score: state.matched * 10,
            moves: state.moves,
            time: totalTime,
            difficulty: 'mild'
        };
        console.log('Submitting results:', results);
        fetch(window.location.href, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(results)
        }).then((res) => {
            console.log('Fetch response:', res);
            window.location.href = '/tasks/patient/tasks/';
        }).catch((err) => {
            console.error('Fetch error:', err);
            window.location.href = '/tasks/patient/tasks/';
        });
    }

    initializeGame();
</script>
{% endblock %}
