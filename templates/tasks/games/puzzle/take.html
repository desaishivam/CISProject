{% extends 'layouts/base.html' %}

{% block title %}Memory Match Puzzle - CogniCare{% endblock %}

{% block content %}
<div class="task-container">
    <div class="task-header">
        <h1 class="task-title">üß† Memory Match Puzzle</h1>
        <p class="task-description">Match each word with its correct category</p>
    </div>
    
    <div class="task-stats">
        <div class="stat-item">
            <span class="stat-number" id="timer">00:00</span>
            <span class="stat-label">Time</span>
        </div>
        <div class="stat-item">
            <span class="stat-number">{{ puzzle_words|length }}</span>
            <span class="stat-label">Questions</span>
        </div>
    </div>
    
    <div class="task-content">
        <form method="post" id="puzzle-form">
            {% csrf_token %}
            {% for item in puzzle_words %}
            <div class="task-item" data-id="{{ item.id }}">
                <span class="task-question">{{ item.word }}</span>
                <select id="{{ item.id }}" name="{{ item.id }}" class="form-select">
                    <option value="">-- Choose Category --</option>
                    <option value="fruit">üçé Fruit</option>
                    <option value="city">üèôÔ∏è City</option>
                    <option value="animal">üêò Animal</option>
                </select>
            </div>
            {% endfor %}
            
            <div class="text-center mt-4">
                <button class="btn provider large" type="submit" name="complete_task">
                    <span>‚úÖ</span>
                    <span>Submit Answers</span>
                </button>
            </div>
        </form>
    </div>
</div>

<style>
    /* All task styling now handled by design system! */
    /* Only puzzle-specific JavaScript interactions remain */
</style>

<script>
  const answers = {
    q1: "fruit",   // Apple
    q2: "city",    // Paris  
    q3: "animal",  // Elephant
    q4: "city",    // Tokyo
    q5: "fruit",   // Banana
    q6: "animal",  // Lion
    q7: "city",    // London
    q8: "fruit",   // Orange
    q9: "animal",  // Tiger
    q10: "city"    // Berlin
  };
  
  let startTime = null;
  let timerInterval = null;

  function startTimer() {
    if (!startTime) {
      startTime = Date.now();
      timerInterval = setInterval(updateTimer, 1000);
    }
  }

  function updateTimer() {
    if (!startTime) return;
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    document.getElementById('timer').textContent = 
      `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  }

  function stopTimer() {
    if (timerInterval) {
      clearInterval(timerInterval);
      timerInterval = null;
    }
  }

    function resetGame() {
        for (let id in answers) {
            document.getElementById(id).value = "";
        }
        document.getElementById('timer').textContent = "00:00";
        stopTimer();
        startTime = null;
    }
    
    document.addEventListener('change', function(e) {
        if (e.target.tagName === 'SELECT') {
            if (!startTime) startTimer();
        }
    });
    
    document.getElementById('puzzle-form').addEventListener('submit', function(e) {
        e.preventDefault();
        stopTimer();
        
        const userAnswers = {};
        let score = 0;
        
    for (let id in answers) {
            const select = document.getElementById(id);
            userAnswers[id] = select.value;
            if (select.value === answers[id]) {
        score++;
            }
    }
    
        // Add hidden fields for score and time
        const scoreInput = document.createElement('input');
        scoreInput.type = 'hidden';
        scoreInput.name = 'score';
        scoreInput.value = score;
        this.appendChild(scoreInput);
        
        const timeInput = document.createElement('input');
        timeInput.type = 'hidden';
        timeInput.name = 'time';
        timeInput.value = document.getElementById('timer').textContent;
        this.appendChild(timeInput);
        
        const answersInput = document.createElement('input');
        answersInput.type = 'hidden';
        answersInput.name = 'answers';
        answersInput.value = JSON.stringify(userAnswers);
        this.appendChild(answersInput);
    
        // Add complete_task field
        const completeInput = document.createElement('input');
        completeInput.type = 'hidden';
        completeInput.name = 'complete_task';
        completeInput.value = '1';
        this.appendChild(completeInput);
        
        // Submit the form using the native form submission
        const form = document.getElementById('puzzle-form');
        form.submit();
  });
</script>
{% endblock %}