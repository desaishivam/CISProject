{% extends 'layouts/base.html' %}
{% block title %}Color Matching Game - CogniCare{% endblock %}
{% block content %}
<div class="color-game-outer">
    <div class="color-game-header">
        <h1>Color Matching Game</h1>
        <p>Find the matching color pairs!</p>
    </div>
    <div class="color-game-container">
        <div class="color-game-instructions">
            Click on cards to find matching colors. Study them first - they'll disappear!
        </div>
        <div class="show-timer" id="show-timer" style="display: none;"></div>
        <div class="score">Score: <span id="score">0</span></div>
        <div class="color-grid" id="color-grid"></div>
        <div class="game-controls">
            <button class="color-game-btn" onclick="startNewGame()">New Game</button>
        </div>
        <div id="feedback" class="feedback" style="display: none;"></div>
    </div>
</div>

<style>
    body, .color-game-outer {
        font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif;
    }
    .color-game-outer {
        min-height: 80vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px 0;
    }
    .color-game-header {
        text-align: center;
        margin-bottom: 20px;
    }
    .color-game-header h1 {
        font-size: 2.5em;
        color: #4facfe;
        margin-bottom: 8px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.12);
    }
    .color-game-header p {
        color: #555;
        font-size: 1.1em;
    }
    .color-game-container {
        background: #fff;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.10);
        padding: 32px 24px 24px 24px;
        max-width: 480px;
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    .color-game-instructions {
        text-align: center;
        color: #666;
        margin-bottom: 18px;
        font-size: 1.08em;
    }
    .score {
        text-align: center;
        font-size: 1.3em;
        font-weight: bold;
        color: #2d3436;
        margin-bottom: 18px;
    }
    .color-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 18px;
        max-width: 400px;
        margin: 0 auto 24px auto;
        width: 100%;
    }
    .color-card {
        aspect-ratio: 1;
        border-radius: 18px;
        border: 3px solid #e0e0e0;
        cursor: pointer;
        transition: all 0.22s cubic-bezier(.4,2,.6,1);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1em;
        font-weight: bold;
        color: white;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.18);
        position: relative;
        background: #b2bec3;
        box-shadow: 0 2px 8px rgba(0,0,0,0.07);
        user-select: none;
    }
    .color-card:hover {
        transform: scale(1.07);
        border-color: #4facfe;
        z-index: 2;
    }
    .color-card.matched {
        opacity: 0.5;
        cursor: not-allowed;
        transform: scale(0.97);
    }
    .color-card.selected {
        border-color: #4facfe !important;
        border-width: 4px !important;
        box-shadow: 0 0 15px rgba(79,172,254,0.18);
    }
    .color-card.hidden {
        background: #dfe6e9 !important;
        color: #b2bec3;
    }
    .color-card.hidden::after {
        content: '?';
        position: absolute;
        font-size: 2em;
        color: #636e72;
        left: 50%;
        top: 50%;
        transform: translate(-50%,-50%);
        pointer-events: none;
    }
    .show-timer {
        text-align: center;
        font-size: 1.1em;
        color: #e17055;
        font-weight: bold;
        margin: 10px 0 8px 0;
    }
    .game-controls {
        text-align: center;
        margin: 18px 0 0 0;
    }
    .color-game-btn {
        padding: 13px 32px;
        font-size: 1.1em;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-weight: bold;
        background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(0,0,0,0.10);
        transition: all 0.18s cubic-bezier(.4,2,.6,1);
    }
    .color-game-btn:hover {
        background: linear-gradient(90deg, #00f2fe 0%, #4facfe 100%);
        transform: translateY(-2px) scale(1.04);
        box-shadow: 0 6px 16px rgba(0,0,0,0.13);
    }
    .feedback {
        text-align: center;
        font-size: 1.08em;
        font-weight: bold;
        margin: 15px 0 0 0;
        padding: 13px;
        border-radius: 10px;
        transition: all 0.2s;
    }
    .feedback.success {
        background: #d4edda;
        color: #218838;
        border: 2px solid #c3e6cb;
    }
    .feedback.error {
        background: #f8d7da;
        color: #c0392b;
        border: 2px solid #f5c6cb;
    }
    @media (max-width: 600px) {
        .color-game-container {
            padding: 18px 4px 12px 4px;
        }
        .color-grid {
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        .color-card {
            font-size: 1em;
        }
        .color-game-header h1 {
            font-size: 2em;
        }
    }
    @media (max-width: 400px) {
        .color-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>

<script>
// Game state
let gameState = {
    score: 0,
    cards: [],
    selectedCard: null,
    matchedPairs: 0,
    totalPairs: 0,
    showTimer: null,
    hideTimer: null,
    cardsVisible: true,
    gameActive: false,
    tries: 0,
    startTime: null,
    endTime: null
};
// Available colors
const colors = [
    { name: 'Red', color: '#e74c3c' },
    { name: 'Blue', color: '#3498db' },
    { name: 'Green', color: '#2ecc71' },
    { name: 'Yellow', color: '#f1c40f' },
    { name: 'Purple', color: '#9b59b6' },
    { name: 'Orange', color: '#e67e22' },
    { name: 'Pink', color: '#e91e63' },
    { name: 'Teal', color: '#1abc9c' }
];

// Task context variables
const COLOR_TASK_ID = "{{ task.id|default:'' }}";
const COLOR_TASK_URL = "{% if task %}{% url 'taskmanager:take_task' task.id %}{% else %}#{% endif %}";
const CSRF_TOKEN = "{% if task %}{{ csrf_token }}{% else %}{% endif %}";

    function startNewGame() {
        // Clear any existing timers
        if (gameState.showTimer) clearTimeout(gameState.showTimer);
        if (gameState.hideTimer) clearTimeout(gameState.hideTimer);

        // Reset game state
        gameState = {
            score: 0,
            cards: [],
            selectedCard: null,
            matchedPairs: 0,
            totalPairs: 0,
            showTimer: null,
            hideTimer: null,
            cardsVisible: true,
            gameActive: false,
            tries: 0,
            startTime: null,
            endTime: null
        };

        // Select 6 colors for the game (12 cards total)
        const selectedColors = colors.slice(0, 6);
        gameState.totalPairs = selectedColors.length;
        
        // Create pairs and shuffle
        const cardPairs = [...selectedColors, ...selectedColors];
        const shuffledCards = cardPairs.sort(() => Math.random() - 0.5);
        
        // Create the game grid
        const grid = document.getElementById('color-grid');
        grid.innerHTML = '';
        
        shuffledCards.forEach((colorData, index) => {
            const card = document.createElement('div');
            card.className = 'color-card';
            card.style.backgroundColor = colorData.color;
            card.textContent = colorData.name;
            card.dataset.colorName = colorData.name;
            card.dataset.originalColor = colorData.color;
            card.dataset.index = index;
            card.onclick = () => selectCard(card, colorData.name, index);
            grid.appendChild(card);
        });
        
        gameState.cards = shuffledCards;
        updateScore();
        hideFeedback();
        
        // Start the show/hide cycle
        startShowHideCycle();
        gameState.tries = 0;
        gameState.startTime = Date.now();
        gameState.endTime = null;
    }

    function selectCard(cardElement, colorName, index) {
        // Only allow selection when game is active and cards are hidden
        if (!gameState.gameActive || gameState.cardsVisible) {
            return;
        }

        // Ignore clicks on matched cards
        if (cardElement.classList.contains('matched')) {
            return;
        }

        // Increment tries for every card flip (or every pair attempt)
        gameState.tries++;

        // Temporarily show the selected card
        revealCard(cardElement);

        // If no card is selected, select this one
        if (!gameState.selectedCard) {
            gameState.selectedCard = { element: cardElement, name: colorName, index: index };
            cardElement.classList.add('selected');
            return;
        }

        // If clicking the same card, deselect it
        if (gameState.selectedCard.index === index) {
            gameState.selectedCard.element.classList.remove('selected');
            hideCard(gameState.selectedCard.element);
            gameState.selectedCard = null;
            return;
        }

        // Check for match
        if (gameState.selectedCard.name === colorName) {
            // Match found!
            cardElement.classList.add('matched');
            gameState.selectedCard.element.classList.add('matched');
            gameState.selectedCard.element.classList.remove('selected');
            
            // Keep matched cards visible
            revealCard(cardElement);
            revealCard(gameState.selectedCard.element);
            
            gameState.score += 10;
            gameState.matchedPairs++;
            
            showFeedback('Great match! ðŸŽ‰', 'success');
            
            // Check if game is complete
            if (gameState.matchedPairs === gameState.totalPairs) {
                gameState.gameActive = false;
                clearTimeout(gameState.showTimer);
                clearTimeout(gameState.hideTimer);
                gameState.endTime = Date.now();
                setTimeout(() => {
                    showFeedback(`Congratulations! You found all ${gameState.totalPairs} pairs! Final Score: ${gameState.score}`, 'success');
                    setTimeout(() => {
                        completeColorTaskAndRedirect();
                    }, 2000);
                }, 1000);
            }
            
            gameState.selectedCard = null;
        } else {
            // No match
            showFeedback('Not a match, try again! ðŸ¤”', 'error');
            
            // Hide both cards after a short delay
            setTimeout(() => {
                if (gameState.selectedCard) {
                    gameState.selectedCard.element.classList.remove('selected');
                    hideCard(gameState.selectedCard.element);
                }
                hideCard(cardElement);
                gameState.selectedCard = null;
            }, 1500);
        }
        
        updateScore();
    }

    function updateScore() {
        document.getElementById('score').textContent = gameState.score;
    }

    function showFeedback(message, type) {
        const feedback = document.getElementById('feedback');
        feedback.textContent = message;
        feedback.className = `feedback ${type}`;
        feedback.style.display = 'block';
        
        // Auto-hide after 3 seconds for success, 2 seconds for error
        const hideDelay = type === 'success' ? 3000 : 2000;
        setTimeout(() => {
            feedback.style.display = 'none';
        }, hideDelay);
    }

    function hideFeedback() {
        document.getElementById('feedback').style.display = 'none';
    }

    function startShowHideCycle() {
        // Show cards for 3 seconds at start
        showAllCards();
        showCountdown(3, "Study the colors!");
        
        gameState.showTimer = setTimeout(() => {
            hideAllCards();
            gameState.gameActive = true;
            showFeedback('Now find the matching pairs!', 'success');
        }, 3000);
    }

    function showAllCards() {
        const cards = document.querySelectorAll('.color-card:not(.matched)');
        cards.forEach(card => {
            revealCard(card);
        });
        gameState.cardsVisible = true;
    }

    function hideAllCards() {
        const cards = document.querySelectorAll('.color-card:not(.matched)');
        cards.forEach(card => {
            hideCard(card);
        });
        gameState.cardsVisible = false;
    }

    function revealCard(card) {
        card.classList.remove('hidden');
        card.style.backgroundColor = card.dataset.originalColor;
        card.textContent = card.dataset.colorName;
    }

    function hideCard(card) {
        if (!card.classList.contains('matched')) {
            card.classList.add('hidden');
            card.textContent = '';
        }
    }

    function showCountdown(seconds, message) {
        const timerElement = document.getElementById('show-timer');
        timerElement.style.display = 'block';
        
        let timeLeft = seconds;
        timerElement.textContent = `${message} ${timeLeft}s`;
        
        const countdown = setInterval(() => {
            timeLeft--;
            if (timeLeft > 0) {
                timerElement.textContent = `${message} ${timeLeft}s`;
            } else {
                timerElement.style.display = 'none';
                clearInterval(countdown);
            }
        }, 1000);
    }

    function completeColorTaskAndRedirect() {
        if (!COLOR_TASK_ID) {
            window.location.href = "{% url 'taskmanager:patient_tasks' %}";
            return;
        }
        const score = gameState.score;
        const tries = gameState.tries;
        let totalTime = 0;
        if (gameState.startTime && gameState.endTime) {
            totalTime = Math.round((gameState.endTime - gameState.startTime) / 1000); // seconds
        }
        const body = `complete_task=1&score=${encodeURIComponent(score)}&tries=${encodeURIComponent(tries)}&time=${encodeURIComponent(totalTime)}`;
        fetch(COLOR_TASK_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': CSRF_TOKEN,
            },
            body: body,
        })
        .then(response => {
            window.location.href = "{% url 'taskmanager:patient_tasks' %}";
        })
        .catch(() => {
            window.location.href = "{% url 'taskmanager:patient_tasks' %}";
        });
    }

    // Start the first game when page loads
    window.onload = function() {
        startNewGame();
    };
</script>
{% endblock %} 