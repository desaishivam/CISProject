{% extends 'layouts/base.html' %}
{% load static %}

{% block title %}{{ task.title }} - Results - CogniCare{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/tasks.css' %}">
{% endblock %}

{% block content %}
{# Unified structure: .container, .section, .card, .mdc-button #}
<div class="container">
    <div class="results-header">
        <h1>{{ task.title }} - Results</h1>
        <div class="task-info">
            <p><strong>Patient:</strong> {{ task.assigned_to.user.first_name }} {{ task.assigned_to.user.last_name }}</p>
            <p><strong>Assigned by:</strong> {{ task.assigned_by.user.first_name }} {{ task.assigned_by.user.last_name }}</p>
            <p><strong>Completed:</strong> {{ task_response.completed_at|date:"M d, Y g:i A" }}</p>
            <p><strong>Status:</strong> <span class="status-{{ task.status }}">{{ task.get_status_display }}</span></p>
        </div>
    </div>

    {% if task.task_type == 'memory_questionnaire' and memory_results %}
        <!-- Memory Questionnaire Results -->
        <div class="memory-results">
            <!-- Summary Section -->
            <div class="section">
                <h3>Assessment Summary</h3>
                <div class="summary-grid">
                    <div class="card">
                        <h4>Overall Score</h4>
                        <div class="score-value">{{ memory_results.overall_score }}/5.0</div>
                        <p>Combined frequency and seriousness rating</p>
                    </div>
                    <div class="card">
                        <h4>Average Frequency</h4>
                        <div class="score-value">{{ memory_results.avg_frequency }}/3.0</div>
                        <p>How often issues occur</p>
                    </div>
                    <div class="card">
                        <h4>Average Seriousness</h4>
                        <div class="score-value">{{ memory_results.avg_seriousness }}/2.0</div>
                        <p>How serious issues are perceived</p>
                    </div>
                    <div class="card">
                        <h4>Issues Assessed</h4>
                        <div class="score-value">{{ memory_results.total_issues }}</div>
                        <p>Total memory areas evaluated</p>
                    </div>
                </div>
            </div>

            <!-- Areas of Concern -->
            {% if memory_results.high_concern_issues %}
            <div class="section">
                <h3>High Concern Areas</h3>
                <div class="concern-list high-concern">
                    {% for issue in memory_results.high_concern_issues %}
                    <div class="concern-item">
                        <div class="issue-name">{{ issue.issue }}</div>
                        <div class="issue-ratings">
                            <span class="frequency">{{ issue.frequency }}</span>
                            <span class="seriousness">{{ issue.seriousness }}</span>
                            <span class="combined-score">Score: {{ issue.combined_score }}/5</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {% if memory_results.moderate_concern_issues %}
            <div class="section">
                <h3>Moderate Concern Areas</h3>
                <div class="concern-list moderate-concern">
                    {% for issue in memory_results.moderate_concern_issues %}
                    <div class="concern-item">
                        <div class="issue-name">{{ issue.issue }}</div>
                        <div class="issue-ratings">
                            <span class="frequency">{{ issue.frequency }}</span>
                            <span class="seriousness">{{ issue.seriousness }}</span>
                            <span class="combined-score">Score: {{ issue.combined_score }}/5</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Memory Techniques -->
            {% if memory_results.techniques %}
            <div class="section">
                <h3>Memory Techniques Used</h3>
                <div class="techniques-list">
                    {% for technique in memory_results.techniques %}
                    <div class="technique-item">
                        <i class="technique-icon">üí°</i>
                        <span>{{ technique }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Detailed Results Table -->
            <div class="section">
                <h3>Detailed Assessment Results</h3>
                <div class="table-container">
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Memory Issue</th>
                                <th>Frequency</th>
                                <th>Seriousness</th>
                                <th>Combined Score</th>
                                <th>Level of Concern</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for issue in memory_results.all_issues %}
                            <tr class="{% if issue.combined_score >= 4 %}high-concern-row{% elif issue.combined_score >= 2 %}moderate-concern-row{% else %}low-concern-row{% endif %}">
                                <td>{{ issue.issue }}</td>
                                <td>{{ issue.frequency }}</td>
                                <td>{{ issue.seriousness }}</td>
                                <td>{{ issue.combined_score }}/5</td>
                                <td>
                                    {% if issue.combined_score >= 4 %}
                                        <span class="concern-badge high">High</span>
                                    {% elif issue.combined_score >= 2 %}
                                        <span class="concern-badge moderate">Moderate</span>
                                    {% else %}
                                        <span class="concern-badge low">Low</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    {% else %}
        <!-- Generic Results Display -->
        <div class="section">
            <h3>Task Responses</h3>
            {% if task_response.responses %}
                <div class="responses-container">
                    {% for key, value in task_response.responses.items %}
                    <div class="response-item">
                        <strong>{{ key|title }}:</strong> {{ value }}
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <p>No detailed responses available for this task.</p>
            {% endif %}
        </div>
    {% endif %}

    <div class="footer-actions">
        <a href="{{ back_url }}" class="action-btn outline-btn">‚Üê Back to Tasks</a>
    </div>
</div>
{% endblock %} 