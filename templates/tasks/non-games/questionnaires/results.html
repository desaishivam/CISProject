{% extends 'layouts/base.html' %}
{% load static %}
{% block extra_css %}
<link rel='stylesheet' href='{% static 'css/games.css' %}'>
{% endblock %}

{% block title %}{{ task.title }} - Results - CogniCare{% endblock %}

{% block content %}
{# Unified structure: .container, .section, .card, .mdc-button #}
<div class="container">
    <div class="results-header">
        <h1>{{ task.title }} - Results</h1>
        <div class="task-info">
            <p><strong>Patient:</strong> {{ task.assigned_to.user.first_name }} {{ task.assigned_to.user.last_name }}</p>
            <p><strong>Assigned by:</strong> {{ task.assigned_by.user.first_name }} {{ task.assigned_by.user.last_name }}</p>
            <p><strong>Completed:</strong> {{ task_response.completed_at|date:"M d, Y g:i A" }}</p>
            <p><strong>Status:</strong> <span class="status-{{ task.status }}">{{ task.get_status_display }}</span></p>
        </div>
    </div>

    {% if task.task_type == 'memory_questionnaire' and memory_results %}
        <!-- Memory Questionnaire Results -->
        <div class="memory-results">
            <!-- Summary Section -->
            <div class="section">
                <h3>Assessment Summary</h3>
                <div class="summary-grid">
                    <div class="card">
                        <h4>Overall Score</h4>
                        <div class="score-value">{{ memory_results.overall_score }}/5.0</div>
                        <p>Combined frequency and seriousness rating</p>
                    </div>
                    <div class="card">
                        <h4>Average Frequency</h4>
                        <div class="score-value">{{ memory_results.avg_frequency }}/3.0</div>
                        <p>How often issues occur</p>
                    </div>
                    <div class="card">
                        <h4>Average Seriousness</h4>
                        <div class="score-value">{{ memory_results.avg_seriousness }}/2.0</div>
                        <p>How serious issues are perceived</p>
                    </div>
                    <div class="card">
                        <h4>Issues Assessed</h4>
                        <div class="score-value">{{ memory_results.total_issues }}</div>
                        <p>Total memory areas evaluated</p>
                    </div>
                </div>
            </div>

            <!-- Areas of Concern -->
            {% if memory_results.high_concern_issues %}
            <div class="section">
                <h3>High Concern Areas</h3>
                <div class="concern-list high-concern">
                    {% for issue in memory_results.high_concern_issues %}
                    <div class="concern-item">
                        <div class="issue-name">{{ issue.issue }}</div>
                        <div class="issue-ratings">
                            <span class="frequency">{{ issue.frequency }}</span>
                            <span class="seriousness">{{ issue.seriousness }}</span>
                            <span class="combined-score">Score: {{ issue.combined_score }}/5</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {% if memory_results.moderate_concern_issues %}
            <div class="section">
                <h3>Moderate Concern Areas</h3>
                <div class="concern-list moderate-concern">
                    {% for issue in memory_results.moderate_concern_issues %}
                    <div class="concern-item">
                        <div class="issue-name">{{ issue.issue }}</div>
                        <div class="issue-ratings">
                            <span class="frequency">{{ issue.frequency }}</span>
                            <span class="seriousness">{{ issue.seriousness }}</span>
                            <span class="combined-score">Score: {{ issue.combined_score }}/5</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Memory Techniques -->
            {% if memory_results.techniques %}
            <div class="section">
                <h3>Memory Techniques Used</h3>
                <div class="techniques-list">
                    {% for technique in memory_results.techniques %}
                    <div class="technique-item">
                        <i class="technique-icon">ðŸ’¡</i>
                        <span>{{ technique }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Detailed Results Table -->
            <div class="section">
                <h3>Detailed Assessment Results</h3>
                <div class="table-container">
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Memory Issue</th>
                                <th>Frequency</th>
                                <th>Seriousness</th>
                                <th>Combined Score</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for issue in memory_results.processed_issues %}
                            <tr class="{% if issue.combined_score >= 4 %}high-concern{% elif issue.combined_score >= 2 %}moderate-concern{% else %}low-concern{% endif %}">
                                <td class="issue-name">{{ issue.issue }}</td>
                                <td class="frequency-cell">
                                    <span class="rating-badge frequency-{{ issue.frequency_score }}">{{ issue.frequency }}</span>
                                </td>
                                <td class="seriousness-cell">
                                    <span class="rating-badge seriousness-{{ issue.seriousness_score }}">{{ issue.seriousness }}</span>
                                </td>
                                <td class="score-cell">
                                    <span class="score-badge score-{{ issue.combined_score }}">{{ issue.combined_score }}/5</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Distribution Charts -->
            <div class="section">
                <h3>Response Distribution</h3>
                <div class="charts-grid">
                    <div class="chart-container">
                        <h4>Frequency Distribution</h4>
                        <div class="distribution-chart">
                            <div class="chart-bar">
                                <div class="bar-label">Not at all</div>
                                <div class="bar-fill" style="width: {{ memory_results.frequency_percentages.not_at_all }}%">
                                    {{ memory_results.frequency_distribution.not_at_all }}
                                </div>
                            </div>
                            <div class="chart-bar">
                                <div class="bar-label">Occasionally</div>
                                <div class="bar-fill" style="width: {{ memory_results.frequency_percentages.occasionally }}%">
                                    {{ memory_results.frequency_distribution.occasionally }}
                                </div>
                            </div>
                            <div class="chart-bar">
                                <div class="bar-label">Frequently</div>
                                <div class="bar-fill" style="width: {{ memory_results.frequency_percentages.frequently }}%">
                                    {{ memory_results.frequency_distribution.frequently }}
                                </div>
                            </div>
                            <div class="chart-bar">
                                <div class="bar-label">Always</div>
                                <div class="bar-fill" style="width: {{ memory_results.frequency_percentages.always }}%">
                                    {{ memory_results.frequency_distribution.always }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h4>Seriousness Distribution</h4>
                        <div class="distribution-chart">
                            <div class="chart-bar">
                                <div class="bar-label">Not Serious</div>
                                <div class="bar-fill" style="width: {{ memory_results.seriousness_percentages.not_serious }}%">
                                    {{ memory_results.seriousness_distribution.not_serious }}
                                </div>
                            </div>
                            <div class="chart-bar">
                                <div class="bar-label">Somewhat Serious</div>
                                <div class="bar-fill" style="width: {{ memory_results.seriousness_percentages.somewhat_serious }}%">
                                    {{ memory_results.seriousness_distribution.somewhat_serious }}
                                </div>
                            </div>
                            <div class="chart-bar">
                                <div class="bar-label">Very Serious</div>
                                <div class="bar-fill" style="width: {{ memory_results.seriousness_percentages.very_serious }}%">
                                    {{ memory_results.seriousness_distribution.very_serious }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <!-- Generic Task Results -->
        <div class="generic-results">
            <div class="section">
                <h3>Task Responses</h3>
                {% if task_response %}
                    {% if questions %}
                        <div class="responses-list">
                            {% for question in questions %}
                                <div class="question-item">
                                    <label>{{ question.text }}</label>
                                    {% with question_key="question_"|add:question.id %}
                                    <input type="text" name="{{ question_key }}" value="{{ task_response.responses.question_key|default:'No response provided' }}">
                                    {% endwith %}
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="general-response">
                            <h4>General Notes</h4>
                            <p>{{ task_response.responses.general_notes|default:"No notes provided" }}</p>
                        </div>
                    {% endif %}
                {% else %}
                    <p>No responses have been submitted for this task yet.</p>
                {% endif %}
            </div>
        </div>
    {% endif %}

    <!-- Action Buttons -->
    <div class="results-actions">
        {% if request.user.profile.user_type == 'patient' %}
            <a href="{% url 'taskmanager:patient_tasks' %}" class="mdc-button mdc-button--outlined">
                <span class="mdc-button__label">Back to My Tasks</span>
            </a>
        {% else %}
            <a href="{% url 'provider_dashboard' %}" class="mdc-button mdc-button--outlined">
                <span class="mdc-button__label">Back to Dashboard</span>
            </a>
        {% endif %}
        
        {% if task.status != 'completed' and request.user.profile.user_type == 'patient' %}
            <a href="{% url 'taskmanager:take_task' task.id %}" class="mdc-button mdc-button--raised">
                <span class="mdc-button__label">Continue Task</span>
            </a>
        {% endif %}
    </div>
</div>

{% endblock %} 